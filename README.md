# Unity Shader Variant Analysis

Shader variant tracing and analysis in the Unity Editor:

* Trace the shader variants generated by your project at build time. 
* Analyze the traces and identify Which shaders and keywords generate the most permutations.
* Identify effective ways to reduce shader build times.

<p align="center">
  <img width="100%" src="https://github.com/eldnach/shader-variant-analysis/blob/main/.github/images/shader-variant-analysis.png?raw=true" alt="ShaderVariants">
</p>

## Background

The Unity Editor generates and compiles a large amount of shader permutations at build time, based on the amount of Shader Keywords declared and evaluated in shaders. This mechanism provides runtime control over shader functionality, while maintaing optimal shader execution performance.

Shader variant generation contributes to an expontential growth in project build times, depending on the amount of shader keywords and render pipeline features enabled:

<p align="center">
  <img width="70%" src="https://github.com/eldnach/shader-variant-analysis/blob/main/.github/images/shader-build-times.jpg?raw=true" alt="ShaderBuiild">
</p>

It is advised to monitor the project's shader variant generation, and ensure no unnecessary variants are created at project build time.  For more information on Unity's shader variant generation see: https://blog.unity.com/engine-platform/2021-lts-improvements-to-shader-build-times-and-memory-usage 

## Requirements
Supported in Unity 2021 LTS and later.

## Setup
1. In the Unity Editor, go to `Window > Package Manager`
2. In the top left of the Package Manager window, click on `+ > Add package from git URL...` 
3. Add the following URL "https://github.com/eldnach/shader-variant-analysis.git" and click `Add`

Once installed, go to `Window > Analysis > Shader Variant Analysis`.

## Usage

Enable the "Trace Next Build" setting (`Shader Variant Analysis > Build Settings > Trace Next Build`), in order to record your project's shader generation at build time. Set the file path where the trace will be saved:

<p align="center">
  <img width="100%" src="https://github.com/eldnach/shader-variant-analysis/blob/main/.github/images/build-settings.png?raw=true" alt="BuildSettings">
</p>

Initiate a project build as usual. Once the build is complete, load the trace (`Shader Variant Analysis > Import Settings > Load Traces`) and analyze the result. The `Tracked Shaders` panel will list all the shader included in the build, along with their respective variant counts.

<p align="center">
  <img width="100%" src="https://github.com/eldnach/shader-variant-analysis/blob/main/.github/images/shaders.png?raw=true" alt="TrackedShadesr">
</p>

You can expand the `Keywords` dropodown, in order to list all the keywords declared in a shader, and their contribution towards variant generation. Keyword tool tips reveal the render pipeline feature which enables each keyword.

<p align="center">
  <img width="100%" src="https://github.com/eldnach/shader-variant-analysis/blob/main/.github/images/shader-keywords.png?raw=true" alt="TrackedKeywords">
</p>

In the above example, the "_ADDITIONAL_LIGHTS_SHADOWS" keyword is included in a large number of variants. This keyword is enabled via the "Addiitonal Lights/Cast Shadows" settings in the Universal Render Pipeline Asset. Disabling graphics features in the project and render pipeline settings will allow the Unity Editor to filter the relevant keywords and reduce shader build time. 

The `Variants` dropdown reveals a detailed view on each variant generated by shader, along with the variant's subshader, pass, stage, platform and keyword set:

<p align="center">
  <img width="100%" src="https://github.com/eldnach/shader-variant-analysis/blob/main/.github/images/shader-variants.png?raw=true" alt="TrackedVariants">
</p>


